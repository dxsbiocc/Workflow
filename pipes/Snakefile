import os
import pandas as pd
from snakemake.utils import min_version
# snakemake built-in report function requires min version 5.1
min_version("5.1.0")

configfile: "../config/config.yaml"

#read the sample file using pandas lib (sample names+ fastq names) and crezate index using the sample name
samples = pd.read_csv(config['data']["sample_file"], sep='\t', index_col=0)
folders =['trimmed', 'dedup', 'macs2', 'macs2/bigwig', 'motifs']
# ------------------ Wildcard constraints ------------------ #
wildcard_constraints:
    sample = "|".join(samples.index),
    folder = "|".join(folders)

if not config.get('workdir'):
    config['workdir'] = os.getcwd()
# work dir
workdir: config['workdir']

# --------------------- make directories ------------------- #
rule all:
    input:
        expand("trimmed/{sample}.clean.{unit}.fq.gz", sample=samples.index, unit=['R1', 'R2']),
        "dedup/{sample}.cons.bam.bai",
        "dedup/{sample}.shift.sort.bam.bai",
        "macs2/narrow/{sample}__peaks.narrowPeak",
        "macs2/broad/{sample}__peaks.narrowPeak",
        "macs2/bigwig/{sample}.cpm.norm.bw",
        "macs2/narrow/{sample}_homer_peaks.txt",
        "motifs/{sample}"

rule make_some_files:
    output:
        protected("{folder}"),
    shell:
        "mkdir {output}"
# ---------------------- include rules --------------------- #
include: "../rules/common.smk"
include: "../rules/qc.smk"
include: "../rules/mapping.smk"
include: "../rules/filtering.smk"
include: "../rules/callpeak.smk"
include: "../rules/motif.smk"