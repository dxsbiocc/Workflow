import os
import pandas as pd
from snakemake.utils import min_version
# snakemake built-in report function requires min version 5.1
min_version("7.12.0")

configfile: "../config/config.yaml"

#read the sample file using pandas lib (sample names+ fastq names) and crezate index using the sample name
samples = pd.read_csv(config['data']["sample_file"], sep='\t', index_col=0)
# ------------------ Wildcard constraints ------------------ #
# wildcard_constraints:
#     sample = "|".join(samples.index)

if not config.get('workdir'):
    config['workdir'] = os.getcwd()
# work dir
workdir: config['workdir']

# ------------------------- run rules ---------------------- #
# report: "report/workflow.rst"

rule all:
    input:
        # trimmed adapter
        expand("trimmed/{sample}.clean.{unit}.fq.gz", sample=samples.index, unit=['R1', 'R2']),
        # spikein
        expand("bowtie2/{sample}.spikein.bam", sample=samples.index),
        # stats
        expand("bowtie2/{sample}.sort.stats.txt", sample=samples.index),
        # mapping and remove duplicates
        expand("dedup/{sample}.cons.bam.bai", sample=samples.index),
        # shift 9bp
        expand("dedup/{sample}.filtered.bam.bai", sample=samples.index),
        # callpeak
        expand("macs2/narrow/{sample}_peaks.narrowPeak", sample=samples.index),
        expand("macs2/broad/{sample}_peaks.broadPeak", sample=samples.index),
        # convert to bigwig
        expand("macs2/bigwig/{sample}.norm.bw", sample=samples.index),
        # extract peaks
        expand("macs2/narrow/{sample}_homer_peaks.txt", sample=samples.index),
        # motify analysis
        expand("motifs/{sample}", sample=samples.index),
        # peak annotate
        expand('macs2/anno/{sample}.peakAnno.{ext}', sample=samples.index, ext=['pdf', 'txt']),
        # bw data quality
        expand("macs2/matrix/{pos}.{types}.png", pos=['tss', 'genebody'], types=['heatmap', 'profile']),

# ---------------------- include rules --------------------- #
include: "../rules/common.smk"
include: "../rules/trimmed.smk"
include: "../rules/mapping.smk"
include: "../rules/filtering.smk"
include: "../rules/callpeak.smk"
include: "../rules/motif.smk"
include: "../rules/quality.smk"